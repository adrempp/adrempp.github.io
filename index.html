<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>This Day in History</title>

  <style>
    :root{
      /* Rainbow Markets palette */
      --bg1: #0b1020;
      --bg2: #111b3a;
      --text: #ffffff;
      --muted: rgba(255,255,255,0.78);

      --r-red:    #ff3b30;
      --r-orange: #ff9500;
      --r-yellow: #ffd60a;
      --r-green:  #34c759;
      --r-blue:   #007aff;
      --r-purple: #af52de;

      --card: rgba(255,255,255,0.07);
      --cardBorder: rgba(255,255,255,0.14);
      --shadow: rgba(0,0,0,0.35);
    }

    html, body { height: 100%; }

    body{
      margin: 0;
      min-height: 100%;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(175,82,222,0.18), transparent 60%),
        radial-gradient(1000px 500px at 85% 20%, rgba(0,122,255,0.18), transparent 60%),
        radial-gradient(900px 500px at 30% 90%, rgba(52,199,89,0.14), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wrap{
      width: 92vw;
      max-width: 1500px;
      padding: 3.5vw;
    }

    .brandbar{
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        var(--r-red),
        var(--r-orange),
        var(--r-yellow),
        var(--r-green),
        var(--r-blue),
        var(--r-purple)
      );
      box-shadow: 0 10px 22px var(--shadow);
      margin-bottom: 22px;
    }

    .header{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 18px;
      gap: 20px;
    }

    .title{
      font-size: clamp(36px, 4vw, 64px);
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .date{
      font-size: clamp(18px, 2vw, 28px);
      color: var(--muted);
      white-space: nowrap;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--cardBorder);
      border-radius: 26px;
      padding: 30px 34px;
      box-shadow: 0 18px 44px var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-height: 280px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border-radius: 999px;
      font-weight: 800;
      font-size: clamp(14px, 1.2vw, 18px);
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
      width: fit-content;
      margin-bottom: 14px;
    }

    .badge.event  { box-shadow: 0 0 0 2px rgba(0,122,255,0.25) inset; }
    .badge.birth  { box-shadow: 0 0 0 2px rgba(52,199,89,0.25) inset; }
    .badge.death  { box-shadow: 0 0 0 2px rgba(255,149,0,0.25) inset; }

    .year{
      color: var(--r-yellow);
      font-weight: 900;
      font-size: clamp(34px, 4vw, 72px);
      line-height: 1;
      margin-bottom: 12px;
    }

    .text{
      font-size: clamp(22px, 2.35vw, 42px);
      line-height: 1.2;
      letter-spacing: 0.1px;
      white-space: pre-line; /* keeps \n formatting in error message */
    }

    .kicker{
      margin-top: 16px;
      color: var(--muted);
      font-size: clamp(16px, 1.6vw, 22px);
    }

    .footer{
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: clamp(14px, 1.3vw, 20px);
    }

    .pill{
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brandbar"></div>

    <div class="header">
      <div class="title">ðŸ“… This Day in History</div>
      <div class="date" id="dateText"></div>
    </div>

    <div class="card">
      <div class="badge event" id="typeBadge">ðŸ“Œ Event</div>
      <div class="year" id="year">â€¦</div>
      <div class="text" id="desc">Loading todayâ€™s historyâ€¦</div>
      <div class="kicker" id="kickerText">Rainbow Markets â€¢ Grab a snack. Learn a fact.</div>
    </div>

    <div class="footer">
      <div class="pill" id="counter">Rotation 0</div>
      <!div class="pill" id="sourcePill">Source: Wikipedia (On This Day) â€¢ US filtered</div>
      <div class="pill" id="sourcePill">Source: Wikipedia</div>
    </div>
  </div>

  <script>
    const dateText   = document.getElementById("dateText");
    const yearEl     = document.getElementById("year");
    const descEl     = document.getElementById("desc");
    const counterEl  = document.getElementById("counter");
    const typeBadge  = document.getElementById("typeBadge");
    const sourcePill = document.getElementById("sourcePill");
    const kickerText = document.getElementById("kickerText");

    function setHeaderDate() {
      const now = new Date();
      dateText.textContent = now.toLocaleDateString(undefined, {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }
    setHeaderDate();

    // --- Rotation controls ---
    // Birth/Death appear only every N rotations (events fill the rest).
    const SPECIAL_EVERY_N = 12;   // change to 10, 15, 20, etc.
    const DEATH_PROB = 0.33;      // on special rotations: chance it's Death (else Birth)
    const ROTATE_MS = 15000;

    // Daily refresh (device local time)
    const RELOADS = [{h:0,m:10},{h:0,m:30}];

    let items = [];
    let events = [];
    let births = [];
    let deaths = [];

    let rot = 0;
    let evIdx = 0, bIdx = 0, dIdx = 0;

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function applyBadge(typeStr) {
      const t = (typeStr || "Event").toLowerCase();
      if (t.includes("birth")) {
        typeBadge.className = "badge birth";
        typeBadge.textContent = "ðŸŽ‚ Birth";
      } else if (t.includes("death")) {
        typeBadge.className = "badge death";
        typeBadge.textContent = "ðŸ•¯ï¸ Death";
      } else {
        typeBadge.className = "badge event";
        typeBadge.textContent = "ðŸ“Œ Event";
      }
    }

    function renderItem(it) {
      yearEl.textContent = it.year || "â€”";
      descEl.textContent = it.text || "â€”";
      applyBadge(it.type);
      counterEl.textContent = `Rotation ${rot}`;
    }

    function nextFrom(poolName) {
      if (poolName === "death" && deaths.length) {
        const it = deaths[dIdx % deaths.length];
        dIdx++;
        return it;
      }
      if (poolName === "birth" && births.length) {
        const it = births[bIdx % births.length];
        bIdx++;
        return it;
      }
      if (events.length) {
        const it = events[evIdx % events.length];
        evIdx++;
        return it;
      }
      return items[0];
    }

    function pickNextItem() {
      rot++;

      // Every N rotations show Birth/Death; otherwise show Event.
      if (SPECIAL_EVERY_N > 0 && rot % SPECIAL_EVERY_N === 0) {
        const wantDeath = Math.random() < DEATH_PROB;

        if (wantDeath && deaths.length) return nextFrom("death");
        if (births.length) return nextFrom("birth");
        if (deaths.length) return nextFrom("death");
      }

      return nextFrom("event");
    }

    async function load() {
      try {
        const res = await fetch(`/data/today.json?v=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        // Source label (optional field from YAML)
        if (data.source) sourcePill.textContent = `Source: ${data.source}`;
        else sourcePill.textContent = "Source: Wikipedia (On This Day)";

        items = (data.items || []).slice();
        if (!items.length) throw new Error("No items found");

        // Split pools by type
        const tOf = (i) => (i.type || "").toLowerCase();
        events = items.filter(i => tOf(i).includes("event"));
        births = items.filter(i => tOf(i).includes("birth"));
        deaths = items.filter(i => tOf(i).includes("death"));

        // Shuffle each pool for variety
        shuffle(events);
        shuffle(births);
        shuffle(deaths);

        // Randomize start points
        rot = 1;
        evIdx = Math.floor(Math.random() * (events.length || 1));
        bIdx  = Math.floor(Math.random() * (births.length || 1));
        dIdx  = Math.floor(Math.random() * (deaths.length || 1));

        // Start with an Event if possible
        const first = events.length ? nextFrom("event") : items[Math.floor(Math.random() * items.length)];
        renderItem(first);

        setInterval(() => {
          const it = pickNextItem();
          renderItem(it);
        }, ROTATE_MS);

      } catch (err) {
        yearEl.textContent = "Today in History";
        descEl.textContent = "Fresh historical highlights are loading.\nPlease check back shortly.";
        counterEl.textContent = "";
        typeBadge.className = "badge event";
        typeBadge.textContent = "â³ Updating";
        sourcePill.textContent = "Source: Wikipedia (On This Day)";
        console.error(err);
      }
    }

    load();

    // âœ… Daily auto-reloads at set times (device local time)
    (function scheduleDailyReloads() {
      function scheduleAt(hour, minute) {
        const now = new Date();
        const next = new Date(now);
        next.setHours(hour, minute, 0, 0);
        if (now >= next) next.setDate(next.getDate() + 1);
        const ms = next - now;
        console.log(`Scheduled page reload at ${hour}:${String(minute).padStart(2,"0")} in (ms):`, ms);
        setTimeout(() => location.reload(true), ms);
      }
      RELOADS.forEach(t => scheduleAt(t.h, t.m));
    })();
  </script>
</body>
</html>
