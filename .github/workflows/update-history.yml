name: Update This Day in History (Pacific Midnight)

on:
  schedule:
  # Run later to allow upstream /today endpoints to roll over
    - cron: "5 7 * * *"   # 12:05am PDT
    - cron: "5 8 * * *"   # 12:05am PST

# Retry run (in case API is still on yesterday at 12:15)
    - cron: "25 7 * * *"   # 12:25am PDT
    - cron: "25 8 * * *"   # 12:25am PST    
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure folders
        run: mkdir -p data

      - name: Guard - only update once per Pacific day
        run: |
          python - <<'PY'
          import json, os
          from datetime import datetime
          from zoneinfo import ZoneInfo

          tz = ZoneInfo("America/Los_Angeles")
          today_pt = datetime.now(tz).strftime("%Y-%m-%d")

          meta_path = "data/meta.json"
          last = None
          if os.path.exists(meta_path):
            try:
              last = json.load(open(meta_path, "r", encoding="utf-8")).get("date")
            except Exception:
              last = None

          if last == today_pt:
            print(f"Already updated for {today_pt}")
            raise SystemExit(0)

          print(f"Proceeding with update for {today_pt}")
          PY

      - name: Fetch DayInHistory data (today endpoints)
        run: |
          curl -sL "https://api.dayinhistory.dev/v1/today/events/" > data/events_raw.json
          curl -sL "https://api.dayinhistory.dev/v1/today/births/" > data/births_raw.json
          curl -sL "https://api.dayinhistory.dev/v1/today/deaths/" > data/deaths_raw.json
      
      # New Normalize section
      - name: Normalize data (correct type labels)
        run: |
          python - <<'PY'
          import json
          from datetime import datetime
          from zoneinfo import ZoneInfo

          def load(p):
            try:
              return json.load(open(p, "r", encoding="utf-8"))
            except Exception:
              return {}

          def clean(s):
            return (s or "").strip()

          def extract_events(raw):
            out = []
            for r in raw.get("results", [])[:25]:
              y = clean(str(r.get("year", "")))
              txt = clean(r.get("description") or r.get("title"))
              if y and txt:
                out.append({"type": "Event", "year": y, "text": txt})
            return out

          def extract_births(raw):
            out = []
            for r in raw.get("results", [])[:25]:
              y = clean(str(r.get("birth_year", "")))
              name = clean(r.get("name"))
              desc = clean(r.get("description"))
              bio  = clean(r.get("bio"))
              # Keep it short for signage: Name — description
              txt = " — ".join([p for p in [name, desc] if p])
              if not txt:
                txt = bio
              if y and txt:
                out.append({"type": "Birth", "year": y, "text": txt})
            return out

          def extract_deaths(raw):
            out = []
            for r in raw.get("results", [])[:25]:
              # Many "death" records still include birth_year; use death_year if present, else fallback
              y = clean(str(r.get("death_year", "") or r.get("year", "") or r.get("birth_year", "")))
              name = clean(r.get("name"))
              desc = clean(r.get("description"))
              bio  = clean(r.get("bio"))
              txt = " — ".join([p for p in [name, desc] if p])
              if not txt:
                txt = bio
              if y and txt:
                out.append({"type": "Death", "year": y, "text": txt})
            return out

          events = load("data/events_raw.json")
          births = load("data/births_raw.json")
          deaths = load("data/deaths_raw.json")

          items = []
          items += extract_events(events)
          # items += extract_births(births)
          # items += extract_deaths(deaths)

          tz = ZoneInfo("America/Los_Angeles")
          today_pt = datetime.now(tz).strftime("%Y-%m-%d")

          if not items:
            raise SystemExit("No items extracted")

          json.dump(
            {"date": today_pt, "items": items},
            open("data/today.json", "w", encoding="utf-8"),
            ensure_ascii=False,
            indent=2
          )

          json.dump(
            {"date": today_pt},
            open("data/meta.json", "w", encoding="utf-8"),
            ensure_ascii=False,
            indent=2
          )

          print(f"Wrote {len(items)} items for {today_pt} (events/births/deaths)")
          PY
#- name: Normalize data (correct type labels)
#        run: |
#          python - <<'PY'
#          import json
#          from datetime import datetime
#          from zoneinfo import ZoneInfo
#
#          def load(p):
#            try:
#              return json.load(open(p, "r", encoding="utf-8"))
#            except Exception:
#              return {}
#
#          def extract(raw, t):
#            out = []
#            for r in raw.get("results", [])[:25]:
#              y = str(r.get("year", "")).strip()
#              txt = (r.get("description") or r.get("title") or "").strip()
#              if y and txt:
#                out.append({"type": t, "year": y, "text": txt})
#            return out
#
#          items = []
#          items += extract(load("data/events_raw.json"), "Event")
#          items += extract(load("data/births_raw.json"), "Birth")
#          items += extract(load("data/deaths_raw.json"), "Death")
#
#          tz = ZoneInfo("America/Los_Angeles")
#          today_pt = datetime.now(tz).strftime("%Y-%m-%d")
#
#          if not items:
#            raise SystemExit("No items extracted")
#
#          json.dump(
#            {"date": today_pt, "items": items},
#            open("data/today.json", "w", encoding="utf-8"),
#            ensure_ascii=False,
#            indent=2
#         )
#
#          json.dump(
#            {"date": today_pt},
#            open("data/meta.json", "w", encoding="utf-8"),
#            ensure_ascii=False,
#            indent=2
#          )
#          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # git add data/today.json data/meta.json
          git add data/*.json
          git commit -m "Daily update (Pacific): This Day in History" || exit 0
          git push
